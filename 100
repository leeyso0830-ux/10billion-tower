import streamlit as st
import pandas as pd
import yfinance as yf
import plotly.express as px

# ---------------------------------------------------------
# [ê¸°ë³¸ ì„¤ì •] í˜ì´ì§€ íƒ€ì´í‹€ ë° ë ˆì´ì•„ì›ƒ
# ---------------------------------------------------------
st.set_page_config(page_title="10ì–µ ê´€ì œíƒ‘", page_icon="ğŸš€", layout="wide")

st.title("ğŸš€ 10ì–µ ë‹¬ì„± í†µí•© ê´€ì œ ì‹œìŠ¤í…œ (V1.1)")
st.markdown("---")

# ---------------------------------------------------------
# [ì‚¬ì´ë“œë°”] ì‚¬ìš©ì ì…ë ¥ (ìì‚° í˜„í™©)
# ---------------------------------------------------------
with st.sidebar:
    st.header("ğŸ“ ìì‚° í˜„í™© ì…ë ¥")
    
    # 1. íˆ¬ìê¸ˆ ì…ë ¥
    new_cash = st.number_input("ğŸ’° ì´ë²ˆ ë‹¬ ì‹ ê·œ íˆ¬ìê¸ˆ (ì›”ê¸‰ ë“±)", value=1500000, step=10000)
    
    st.markdown("---")
    st.subheader("ğŸ¦ í˜„ê¸ˆì„± ìì‚°")
    # [V1.1 ì¶”ê°€] CMA/íŒŒí‚¹í†µì¥ ì…ë ¥
    cur_cma = st.number_input("0. CMA/íŒŒí‚¹í†µì¥ (í˜„ê¸ˆ)", value=0, step=10000)

    st.subheader("ğŸ“Š íˆ¬ì ìì‚° (í‰ê°€ê¸ˆì•¡)")
    
    # 2. íˆ¬ì ìì‚°ë³„ í˜„ì¬ í‰ê°€ê¸ˆì•¡ ì…ë ¥
    cur_tech = st.number_input("1. í…Œí¬ Top 10 (ì›)", value=0, step=10000)
    cur_snp = st.number_input("2. S&P 500 (ì›)", value=0, step=10000)
    cur_div = st.number_input("3. ë°°ë‹¹ ì„±ì¥ (ì›)", value=0, step=10000)
    cur_coin = st.number_input("4. ë¹„íŠ¸ì½”ì¸ (ì›)", value=0, step=10000)

    # í™˜ìœ¨ ì •ë³´ ìë™ í˜¸ì¶œ
    try:
        exchange_rate = yf.Ticker("KRW=X").history(period="1d")['Close'].iloc[-1]
        st.success(f"ğŸ‡ºğŸ‡¸ í˜„ì¬ í™˜ìœ¨: {exchange_rate:,.2f} ì›/$")
    except:
        st.warning("í™˜ìœ¨ ì •ë³´ í˜¸ì¶œ ì‹¤íŒ¨ (ì¸í„°ë„· í™•ì¸)")

# ---------------------------------------------------------
# [ë©”ì¸] ë°ì´í„° ì²˜ë¦¬ ë° ë¦¬ë°¸ëŸ°ì‹± ë¡œì§
# ---------------------------------------------------------

# ëª©í‘œ ë¹„ì¤‘ (íˆ¬ì ìì‚° 4:3:2:1)
targets = {
    "í…Œí¬ Top 10": 0.40,
    "S&P 500": 0.30,
    "ë°°ë‹¹ ì„±ì¥": 0.20,
    "ë¹„íŠ¸ì½”ì¸": 0.10
}

# ê³„ì‚° ë¡œì§
invest_holdings = [cur_tech, cur_snp, cur_div, cur_coin] # íˆ¬ì ìì‚°ë§Œ
invest_total = sum(invest_holdings) # íˆ¬ì ìì‚° í•©ê³„
total_net_worth = invest_total + cur_cma # [V1.1] ì´ ìì‚° (CMA í¬í•¨)

# ë¦¬ë°¸ëŸ°ì‹± ê³„ì‚° (íˆ¬ì ìì‚° + ì‹ ê·œ íˆ¬ìê¸ˆ ê¸°ì¤€)
final_invest_total = invest_total + new_cash

data = []
for i, (name, ratio) in enumerate(targets.items()):
    cur_val = invest_holdings[i]
    target_val = final_invest_total * ratio
    diff = target_val - cur_val
    
    action = "ìœ ì§€"
    
    if diff > 0:
        action = f"âœ… {diff:,.0f}ì› ë§¤ìˆ˜"
    elif diff < 0:
        action = f"ğŸ”» {abs(diff):,.0f}ì› ë§¤ë„/í™€ë”©"
        
    data.append([name, cur_val, ratio, target_val, diff, action])

df = pd.DataFrame(data, columns=["ìì‚°ëª…", "í˜„ì¬ë³´ìœ ", "ëª©í‘œë¹„ì¤‘", "ëª©í‘œê¸ˆì•¡", "ì°¨ì•¡", "ì§€ì¹¨"])

# ---------------------------------------------------------
# [ì‹œê°í™”] ëŒ€ì‹œë³´ë“œ í™”ë©´ êµ¬ì„±
# ---------------------------------------------------------

# 1. ìš”ì•½ ë©”íŠ¸ë¦­ (ìµœìƒë‹¨ ê°•ì¡°)
col1, col2, col3, col4 = st.columns(4)
col1.metric("ğŸ’ ì´ ìˆœìì‚° (CMA í¬í•¨)", f"{total_net_worth:,.0f} ì›")
col2.metric("ğŸ“ˆ ì´ ìš´ìš© ìì‚° (íˆ¬ì)", f"{invest_total:,.0f} ì›")
col3.metric("ğŸ’° CMA (ë¹„ìƒê¸ˆ/ëŒ€ê¸°)", f"{cur_cma:,.0f} ì›")
col4.metric("â• íˆ¬ì… ì˜ˆì •", f"{new_cash:,.0f} ì›")

# 2. ë¦¬ë°¸ëŸ°ì‹± ì£¼ë¬¸í‘œ
st.subheader("ğŸ“‹ ë¦¬ë°¸ëŸ°ì‹± ì£¼ë¬¸í‘œ (4:3:2:1)")
st.caption("â€» CMA í˜„ê¸ˆì€ ë¦¬ë°¸ëŸ°ì‹± ê³„ì‚°ì—ì„œ ì œì™¸í•˜ê³ , ìˆœìˆ˜ íˆ¬ì ìì‚° ë¹„ìœ¨ë§Œ ë§ì¶¥ë‹ˆë‹¤.")
st.dataframe(
    df[["ìì‚°ëª…", "í˜„ì¬ë³´ìœ ", "ëª©í‘œê¸ˆì•¡", "ì§€ì¹¨"]].style.format({
        "í˜„ì¬ë³´ìœ ": "{:,.0f}ì›",
        "ëª©í‘œê¸ˆì•¡": "{:,.0f}ì›"
    }),
    use_container_width=True,
    height=200
)

# 3. ì‹œê°í™” (ì°¨íŠ¸)
st.subheader("ğŸ“ˆ í¬íŠ¸í´ë¦¬ì˜¤ ë¶„ì„")
c1, c2 = st.columns(2)

with c1:
    # [V1.1 ìˆ˜ì •] CMAë¥¼ í¬í•¨í•œ ì „ì²´ ìì‚° êµ¬ì„± íŒŒì´ì°¨íŠ¸
    all_assets_labels = list(targets.keys()) + ["CMA (í˜„ê¸ˆ)"]
    all_assets_values = invest_holdings + [cur_cma]
    
    fig_pie = px.pie(values=all_assets_values, names=all_assets_labels, title="ì „ì²´ ìì‚° êµ¬ì„± (CMA í¬í•¨)")
    fig_pie.update_traces(textposition='inside', textinfo='percent+label')
    st.plotly_chart(fig_pie, use_container_width=True)

with c2:
    # ëª©í‘œ vs í˜„ì¬ ë°” ì°¨íŠ¸ (íˆ¬ì ìì‚°ë§Œ)
    fig_bar = px.bar(df, x="ìì‚°ëª…", y=["í˜„ì¬ë³´ìœ ", "ëª©í‘œê¸ˆì•¡"], barmode="group", title="íˆ¬ì ëª©í‘œ ë‹¬ì„± í˜„í™©")
    st.plotly_chart(fig_bar, use_container_width=True)
